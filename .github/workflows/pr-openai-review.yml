name: PR AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Fetch Changed Code
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching PR changes..."
          gh pr diff ${{ github.event.pull_request.number }} > pr_changes.txt
          head -c 5000 pr_changes.txt > truncated_changes.txt # Limit input size

      - name: Get AI Review from Free API
        run: |
          echo "Sending request to AI API..."
          API_RESPONSE=$(curl -s -X POST "https://api-inference.huggingface.co/models/microsoft/codebert-base" \
              -H "Authorization: Bearer ${{ secrets.HUGGINGFACE_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"inputs\": \"$(jq -Rs . < truncated_changes.txt)\"}")

          echo "AI API Response: $API_RESPONSE"

          if [[ -z "$API_RESPONSE" || "$API_RESPONSE" == "null" ]]; then
              echo "AI analysis failed." > comment.txt
          else
              echo "### AI Code Review:" > comment.txt
              echo "$API_RESPONSE" | jq -r . >> comment.txt
          fi

      - name: Post AI Review as PR Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT=$(cat comment.txt)
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
